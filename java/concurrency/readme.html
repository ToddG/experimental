<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>Java Concurrency</title>
<meta name="author" content="Todd D. Greenwood-Geer" />
<meta name="date" content="Mon Jul 19  2010" />
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="java-concurrency">
<h1 class="title">Java Concurrency</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Todd D. Greenwood-Geer</td></tr>
<tr><th class="docinfo-name">Date:</th>
<td>Mon Jul 19  2010</td></tr>
<tr><th class="docinfo-name">Version:</th>
<td>0.1</td></tr>
</tbody>
</table>
<div class="section" id="what-s-the-difference-between-volatile-and-synchronized">
<h1><a class="toc-backref" href="#id11">What's the difference between volatile and synchronized?</a></h1>
<p>As a developer, you may have a <em>slightly</em> fuzzy idea as to the differences between 'volatile' and 'synchronized' variables. At a high level, both the 'volatile' and 'synchronized' keywords provide synchronization semantics for fields within a class or class instance. Individual fields may be declared volatile, and as such are guaranteed to be 'thread safe'. Applying the 'synchronized' keyword to a code block or method guarantees that the block or method must acquire a lock prior to executing the code within the block. I'm intentionaly leaving these descriptions vague, as we'll be investigate what this means in this article.</p>
<p>Example: Volatile:</p>
<pre class="literal-block">
public class FooVolatile(){
    private volatile int i;
    public int getI(){
        return i;
    }
}
</pre>
<p>Example: Synchronized:</p>
<pre class="literal-block">
public class FooSynchronized(){
    private volatile int i;
    public synchronized int getI(){
        return i;
    }
}
</pre>
<p><strong>This article addresses the question: what is the difference, if any, between these two code fragments?</strong></p>
<hr class="docutils" />
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#what-s-the-difference-between-volatile-and-synchronized" id="id11">What's the difference between volatile and synchronized?</a><ul>
<li><a class="reference internal" href="#byte-code" id="id12">Byte Code</a><ul>
<li><a class="reference internal" href="#class-byte-code" id="id13">Class Byte Code</a></li>
<li><a class="reference internal" href="#field-byte-code" id="id14">Field Byte Code</a></li>
<li><a class="reference internal" href="#accessor-byte-code" id="id15">Accessor Byte Code</a></li>
<li><a class="reference internal" href="#voltile-field-byte-code" id="id16">Voltile Field Byte Code</a></li>
<li><a class="reference internal" href="#synchronized-method-byte-code" id="id17">Synchronized Method Byte Code</a></li>
<li><a class="reference internal" href="#synchronized-code-block-byte-code" id="id18">Synchronized Code Block Byte Code</a><ul>
<li><a class="reference internal" href="#complete-class" id="id19">Complete Class</a></li>
<li><a class="reference internal" href="#class-header" id="id20">Class Header</a></li>
<li><a class="reference internal" href="#constructor" id="id21">Constructor</a></li>
<li><a class="reference internal" href="#getter" id="id22">Getter</a></li>
<li><a class="reference internal" href="#setter" id="id23">Setter</a></li>
<li><a class="reference internal" href="#byte-code-summary" id="id24">Byte Code Summary</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#language-definition" id="id25">Language Definition</a></li>
<li><a class="reference internal" href="#jvm-definition" id="id26">JVM Definition</a></li>
<li><a class="reference internal" href="#references" id="id27">References</a></li>
</ul>
</li>
</ul>
</div>
<hr class="docutils" />
<p>I'll break this down into three different areas:</p>
<ol class="arabic simple">
<li>Language Definition : What does the langugage spec say? See <a class="citation-reference" href="#jls3" id="id1">[JLS3]</a>, <a class="citation-reference" href="#jpl4" id="id2">[JPL4]</a>.</li>
<li>Emitted ByteCode : What does an examination of the byte code show? See <a class="citation-reference" href="#pjvm" id="id3">[PJVM]</a>.</li>
<li>JVM : What are the rules the JVM is playing by? See <a class="citation-reference" href="#jvms2" id="id4">[JVMS2]</a>.</li>
</ol>
<p>By the way, if you haven't yet, check out <a class="citation-reference" href="#jamex" id="id5">[JAMEX]</a>. Neil Coffey's site is a great resource.</p>
<div class="section" id="byte-code">
<h2><a class="toc-backref" href="#id12">Byte Code</a></h2>
<p>If you're like me, then you like looking 'under the hood' to see what's going on. I'm reading Joshua Engel's book, <em>Programming for the Java Virtual Machine</em> <a class="citation-reference" href="#pjvm" id="id6">[PJVM]</a>, and I really like the ability to analyze class files at a higher abstraction than the raw bytes. For this, Engel presents Oolong, a language that uses &quot;words and numbers in place of binary values&quot;. This means that we can convert java class files into a human readable format...but they are still class files, not java code. In this section, we're going to incrementally build a java class and examine the Oolong output. This way, we can more easily understand the impact, at the byte code level, of marking a field as volatile, or a method or code block as synchronized.</p>
<p>Note: Sources are available at <a class="citation-reference" href="#toddg" id="id7">[TODDG]</a>.</p>
<div class="section" id="class-byte-code">
<h3><a class="toc-backref" href="#id13">Class Byte Code</a></h3>
<p>Let's start with the most basic class file possible:</p>
<p>Example: Class1.java</p>
<pre class="literal-block">
public class Class1 {
}
</pre>
<p>If we compile Class1.java to Class1.class, and then decompile using Gnoloo, then we wind up with the following Oolong code. Again, Oolong is simply a human readable version of the class file, and is fully described here <a class="citation-reference" href="#pjvm" id="id8">[PJVM]</a>. The directives are also fully described in <a class="citation-reference" href="#jvms2" id="id9">[JVMS2]</a>.</p>
<p>Here's how I compiled and decompiled the classes:</p>
<pre class="literal-block">
javac [class].java -d build.out/
java -cp $PATH Gnoloo build.out/[class].class &gt;  build.out/[class].j
</pre>
<p>This assumes that you've unziped the lib/0201309726_CD.zip and placed the contents in your PATH.</p>
<p>Example: Class1.j  (Note the suffix 'j' for Oolong files):</p>
<pre class="literal-block">
.source Class1.java
.class public super Class1
.super java/lang/Object

.method public &lt;init&gt; ()V
.limit stack 1
.limit locals 1
.var 0 is this LClass1; from l0 to l5
.line 1
l0:    aload_0
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
l4:    return

.end method
</pre>
<p>See <a class="citation-reference" href="#pjvm" id="id10">[PJVM]</a> for full details on the Oolong language. The part that I want to highlight is the following...</p>
<p>The .var statement is literally stating that variable 0 is the <em>this</em> class, Class1:</p>
<pre class="literal-block">
.var 0 is this LClass1; from l0 to l5
</pre>
<p>A .line statement is added to assist a debugger, should one be attached. (That's also what the .source line above was for, too:</p>
<pre class="literal-block">
.line 1
</pre>
<p>Push the reference to <em>this</em> stored in varible 0 onto the stack:</p>
<pre class="literal-block">
l0:    aload_0
</pre>
<p>Invoke the super class init method:</p>
<pre class="literal-block">
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
</pre>
<p>Return:</p>
<pre class="literal-block">
l4:    return
</pre>
<p>This is so cool. If you don't have it, get a copy of Engel's book.</p>
</div>
<div class="section" id="field-byte-code">
<h3><a class="toc-backref" href="#id14">Field Byte Code</a></h3>
<p>Ok, to continue, let's see what happens when we add a field to the class.</p>
<p>Example: Class2.java</p>
<pre class="literal-block">
public class Class2 {
    private int i;
}
</pre>
<p>Example: Class2.j</p>
<pre class="literal-block">
.source Class2.java
.class public super Class2
.super java/lang/Object

.field private i I

.method public &lt;init&gt; ()V
.limit stack 1
.limit locals 1
.var 0 is this LClass2; from l0 to l5
.line 1
l0:    aload_0
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
l4:    return

.end method
</pre>
<p>Oolong shows that we added a new private field:</p>
<pre class="literal-block">
.field private i I
</pre>
<p>Note that 'I' means int. If it had been an Integer, then this line would have been &quot;.field private i Ljava.lang.Integer;&quot; So that was not terribly exciting. We add a field, and we can see it in Oolong. No big deal.</p>
</div>
<div class="section" id="accessor-byte-code">
<h3><a class="toc-backref" href="#id15">Accessor Byte Code</a></h3>
<p>Now let's add the getters and setters for our private variable.</p>
<p>Example: Class3.java</p>
<pre class="literal-block">
public class Class3 {
    private int i;

    public int getI() {
        return i;
    }

    public void setI(int i) {
        this.i = i;
    }
}
</pre>
<p>Adding these two methods produces considerably more Oolong code. I've broken the returned class into several parts below.</p>
<p>Example: Class3.j : The class is the same:</p>
<pre class="literal-block">
.source Class3.java
.class public super Class3
.super java/lang/Object

.field private i I

.method public &lt;init&gt; ()V
.limit stack 1
.limit locals 1
.var 0 is this LClass3; from l0 to l5
.line 1
l0:    aload_0
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
l4:    return

.end method
</pre>
<p>The basic class is the same, including the class header, the field, and the constructor.</p>
<p>Example: Class3.j : Getter byte code:</p>
<pre class="literal-block">
.method public getI ()I
.limit stack 1
.limit locals 1
.var 0 is this LClass3; from l0 to l5
.line 5
l0:    aload_0
l1:    getfield Class3/i I
l4:    ireturn

.end method
</pre>
<p>I'll explain the getter in detail. First, we define the method:</p>
<pre class="literal-block">
.method public getI ()I
</pre>
<p>This is a public method that returns an int (remember, 'I' means 'int', not Integer).</p>
<p>Here we're again storing <em>this</em> in variable 0:</p>
<pre class="literal-block">
.var 0 is this LClass3; from l0 to l5
</pre>
<p>And again, we're pushing the reference in variable 0 (<em>this</em>) onto the stack:</p>
<pre class="literal-block">
l0:    aload_0
</pre>
<p>At this point, we're invoking the getfield on the class. Notice how the field is qualified by [classname]/[fieldname]. The type is declared as in int.</p>
<blockquote>
l1:    getfield Class3/i I</blockquote>
<p>The last operation in the method is to return an int:</p>
<pre class="literal-block">
l4:    ireturn
</pre>
<p>Example: Class3.j : And we've added a setter:</p>
<pre class="literal-block">
.method public setI (I)V
.limit stack 2
.limit locals 2
.var 0 is this LClass3; from l0 to l6
.var 1 is i I from l0 to l6
.line 9
l0:    aload_0
l1:    iload_1
l2:    putfield Class3/i I
.line 10
l5:    return

.end method
</pre>
<p>Let's take the setter apart. The method definition states that it has one int parameter, <em>I</em>, and it returns void, <em>V</em>:</p>
<pre class="literal-block">
.method public setI (I)V
</pre>
<p>Again we declare variable 0 is a reference to <em>this</em>:</p>
<pre class="literal-block">
.var 0 is this LClass3; from l0 to l6
</pre>
<p>Next we declare variable 1 is in integer. Basically, for a class instance, variable 0 is the class, and subsequent variables are the parameters passed to the method:</p>
<pre class="literal-block">
.var 1 is i I from l0 to l6
</pre>
<p>Push the variables onto the stack so that they can be consumed by the putfield operaiton:</p>
<pre class="literal-block">
l0:    aload_0
l1:    iload_1
</pre>
<p>The putfield operation pops the parameter and class instance reference off the stack and sets the value of the instance field:</p>
<pre class="literal-block">
l2:    putfield Class3/i I
</pre>
<p>Nothing to return, so we just return:</p>
<pre class="literal-block">
l5:    return
</pre>
</div>
<div class="section" id="voltile-field-byte-code">
<h3><a class="toc-backref" href="#id16">Voltile Field Byte Code</a></h3>
<p>In Class4, the only difference introduced is making the integer field 'i' volatile:</p>
<p>Example: Class4.java : 'i' is volatile:</p>
<pre class="literal-block">
public class Class4 {
    private volatile int i;

    public int getI() {
        return i;
    }

    public void setI(int i) {
        this.i = i;
    }
}
</pre>
<p>Example: Class4.j : the field reference for 'i' is now marked 'volatile':</p>
<pre class="literal-block">
.source Class4.java
.class public super Class4
.super java/lang/Object

.field private volatile i I
</pre>
<p>Interestingly enough, the only change to the byte code is the addition of the 'volatile' attribute to the field.</p>
</div>
<div class="section" id="synchronized-method-byte-code">
<h3><a class="toc-backref" href="#id17">Synchronized Method Byte Code</a></h3>
<p>Example Class5.java : synchronize the accessors</p>
<pre class="literal-block">
public class Class5 {
    private int i;

    public synchronized int getI() {
        return i;
    }

    public synchronized void setI(int i) {
        this.i = i;
    }
}
</pre>
<p>Example Class5.j : the only byte code changes are in the method attributes:</p>
<pre class="literal-block">
.source Class5.java
.class public super Class5
.super java/lang/Object

.field private i I

.method public &lt;init&gt; ()V
.limit stack 1
.limit locals 1
.var 0 is this LClass5; from l0 to l5
.line 1
l0:    aload_0
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
l4:    return

.end method

.method public synchronized getI ()I
.limit stack 1
.limit locals 1
.var 0 is this LClass5; from l0 to l5
.line 5
l0:    aload_0
l1:    getfield Class5/i I
l4:    ireturn

.end method

.method public synchronized setI (I)V
.limit stack 2
.limit locals 2
.var 0 is this LClass5; from l0 to l6
.var 1 is i I from l0 to l6
.line 9
l0:    aload_0
l1:    iload_1
l2:    putfield Class5/i I
.line 10
l5:    return

.end method
</pre>
<p>Both the set and get methods are now marked as synchronized. No other changes have been made.</p>
</div>
<div class="section" id="synchronized-code-block-byte-code">
<h3><a class="toc-backref" href="#id18">Synchronized Code Block Byte Code</a></h3>
<p>Example Class6.java : synchronize code blocks in the accessors</p>
<pre class="literal-block">
public class Class6 {
    private int i;

    public int getI() {
        synchronized (this) {
            return i;
        }
    }

    public void setI(int i) {
        synchronized (this) {
            this.i = i;
        }
    }
}
</pre>
<p>This minor looking change has introduced a host of changes in the generated byte code. First of all, there are 'monitorenter' and 'monitorexit' istructions. This is an explicit, bytecode level use of the monitor on the class instance, where it was implicit in Example 5 where we synchronized the method.</p>
<div class="section" id="complete-class">
<h4><a class="toc-backref" href="#id19">Complete Class</a></h4>
<p>Example Class6.j (complete):</p>
<pre class="literal-block">
.source Class6.java
.class public super Class6
.super java/lang/Object

.field private i I

.method public &lt;init&gt; ()V
.limit stack 1
.limit locals 1
.var 0 is this LClass6; from l0 to l5
.line 1
l0:    aload_0
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
l4:    return

.end method

.method public getI ()I
.limit stack 2
.limit locals 3
.catch all from l4 to l10 using l11
.catch all from l11 to l14 using l11
.var 0 is this LClass6; from l0 to l16
.line 5
l0:    aload_0
l1:    dup
l2:    astore_1
l3:    monitorenter
.line 6
l4:    aload_0
l5:    getfield Class6/i I
l8:    aload_1
l9:    monitorexit
l10:    ireturn
.line 7
l11:    astore_2
l12:    aload_1
l13:    monitorexit
l14:    aload_2
l15:    athrow

.end method

.method public setI (I)V
.limit stack 2
.limit locals 4
.catch all from l4 to l11 using l14
.catch all from l14 to l17 using l14
.var 0 is this LClass6; from l0 to l20
.var 1 is i I from l0 to l20
.line 11
l0:    aload_0
l1:    dup
l2:    astore_2
l3:    monitorenter
.line 12
l4:    aload_0
l5:    iload_1
l6:    putfield Class6/i I
.line 13
l9:    aload_2
l10:    monitorexit
l11:    goto l19
l14:    astore_3
l15:    aload_2
l16:    monitorexit
l17:    aload_3
l18:    athrow
.line 14
l19:    return

.end method
</pre>
</div>
<div class="section" id="class-header">
<h4><a class="toc-backref" href="#id20">Class Header</a></h4>
<p>Let's break this down, line by line...</p>
<p>Declare the source file, usefull for debugging:</p>
<pre class="literal-block">
.source Class6.java
</pre>
<p>Declare the class as 'Class6':</p>
<pre class="literal-block">
.class public super Class6
</pre>
<p>Declare the super class as Object:</p>
<pre class="literal-block">
.super java/lang/Object
</pre>
<p>Declare the private int field:</p>
<pre class="literal-block">
.field private i I
</pre>
</div>
<div class="section" id="constructor">
<h4><a class="toc-backref" href="#id21">Constructor</a></h4>
<p>Declare the public constructor:</p>
<pre class="literal-block">
.method public &lt;init&gt; ()V
</pre>
<p>Stack stuff that the compiler would infer if it wasn't provided:</p>
<pre class="literal-block">
.limit stack 1
.limit locals 1
</pre>
<p>Variable 0 is a reference to <em>this</em> class, 'Class6':</p>
<pre class="literal-block">
.var 0 is this LClass6; from l0 to l5
</pre>
<p>Debugger info:</p>
<pre class="literal-block">
.line 1
</pre>
<p>Load the variable 0, the <em>this</em> reference, onto the operand stack:</p>
<pre class="literal-block">
l0:    aload_0
</pre>
<p>Operand stack == [<em>this</em>]</p>
<p>Invokespecial directly invokes the super class's init() method, bypassing the normal virtual dispatch mechanism:</p>
<pre class="literal-block">
l1:    invokespecial java/lang/Object/&lt;init&gt; ()V
</pre>
<p>Return void from this method:</p>
<pre class="literal-block">
l4:    return
</pre>
<p>End of method:</p>
<pre class="literal-block">
.end method
</pre>
</div>
<div class="section" id="getter">
<h4><a class="toc-backref" href="#id22">Getter</a></h4>
<p>Now things are going to get interesting. Both the get and set methods now have explicit 'monitorenter' and 'monitorexit' operands, as well as catch blocks, and a throws clause:</p>
<pre class="literal-block">
.method public getI ()I
</pre>
<p>Stack stuff...:</p>
<pre class="literal-block">
.limit stack 2
.limit locals 3
</pre>
<p>Two catch blocks are defined, one for the method, and one for the exception handler:</p>
<pre class="literal-block">
.catch all from l4 to l10 using l11
</pre>
<p>This is the catch block for the handler, note how we're catching from l11 to l14, and assigning to the handler at l11:</p>
<pre class="literal-block">
.catch all from l11 to l14 using l11
</pre>
<p>Variable 0 is the <em>this</em> refernece to Class6:</p>
<pre class="literal-block">
.var 0 is this LClass6; from l0 to l16
</pre>
<p>Debugger stuff:</p>
<pre class="literal-block">
.line 5
</pre>
<p>Push the reference in variable 0 onto the operand stack:</p>
<pre class="literal-block">
l0:    aload_0
</pre>
<p>The operand stack is now: [<em>this</em>]</p>
<p>Duplicate the reference copying the top item on the operand stack and pushing it on the stack:</p>
<pre class="literal-block">
l1:    dup
</pre>
<p>The operand stack is now: [<em>this</em>, <em>this</em>]</p>
<p>Pop one of the references to <em>this</em> off the operand stack and store in a local variable, 1:</p>
<pre class="literal-block">
l2:    astore_1
</pre>
<p>Enter the critical section by taking/incrementing a lock on the reference on the top of the stack:</p>
<pre class="literal-block">
l3:    monitorenter
</pre>
<p>The monitorenter consumes one of the <em>this</em> references from the top of the stack. The operand stack is now: [<em>this</em>].</p>
<p>Debugger:</p>
<pre class="literal-block">
.line 6
</pre>
<p>Push the reference in variable 0 onto the operand stack:</p>
<pre class="literal-block">
l4:    aload_0
</pre>
<p>The operand stack is now: [<em>this</em>, <em>this</em>]</p>
<p>Invoke getField an instance of Class6/i and return an integer:</p>
<pre class="literal-block">
l5:    getfield Class6/i I
</pre>
<p>The operand stack is now: [<em>this</em>, (integer value)]</p>
<p>Get the reference object that we used for monitorenter, and push onto the stack:</p>
<pre class="literal-block">
l8:    aload_1
</pre>
<p>The operand stack is now: [<em>this</em>, (integer value), <em>this</em>]. Monitor exit pops that referenece off the stack and releases/decrements it's lock on that object:</p>
<pre class="literal-block">
l9:    monitorexit
</pre>
<p>The operand stack is now: [<em>this</em>, (integer value)].</p>
<p>Return the integer value on the top of the stack:</p>
<pre class="literal-block">
l10:    ireturn
</pre>
<p>Debugger:</p>
<pre class="literal-block">
.line 7
</pre>
<p>L11 was declared as an exception handler in the catch directive above. TODO: I don't fully understand this... but assuming that the getField method failed above, then the operand stack would be [<em>this</em>]...that means that astore would be storing this reference on the top of the operand stack in local variable 2:</p>
<pre class="literal-block">
l11:    astore_2
</pre>
<p>Load the <em>this</em> reference tucked away in varable 1 so that the monitorexit can decrement/release the lock on it:</p>
<pre class="literal-block">
l12:    aload_1
l13:    monitorexit
</pre>
<p>Load the <em>this</em> reference back onto the stack from variable 2, and then throw out of this method using that reference:</p>
<pre class="literal-block">
l14:    aload_2
l15:    athrow
</pre>
<p>End method:</p>
<pre class="literal-block">
.end method
</pre>
<p>For me, the really interesting part is the declaration of the catch directives together with the unwinding of the stack in the exception handler.</p>
</div>
<div class="section" id="setter">
<h4><a class="toc-backref" href="#id23">Setter</a></h4>
<p>The setter is much the same as the getter.</p>
</div>
<div class="section" id="byte-code-summary">
<h4><a class="toc-backref" href="#id24">Byte Code Summary</a></h4>
<p>So, in summary, we were able to examine the byte code for a simple set of classes that used either 'volatile' or 'synchronized' keywords to insure thread safety of a single mutable field. I was hoping that this would clearly show that these are either functionally the same or different from the perspective of the JVM. However, while we can infer some of the JVM behaviors from the byte code in Class6, this is not definitive. So, we're going to have to peer under the hood and look closely at the definition of the Language and the JVM in order to clarify this question further.</p>
</div>
</div>
</div>
<div class="section" id="language-definition">
<h2><a class="toc-backref" href="#id25">Language Definition</a></h2>
<p>TODO:</p>
<ul class="simple">
<li>Java Memory Model</li>
<li>Happens-Before Relationships</li>
<li>Threads and Locks</li>
<li>Actions</li>
</ul>
</div>
<div class="section" id="jvm-definition">
<h2><a class="toc-backref" href="#id26">JVM Definition</a></h2>
<p>TODO:</p>
</div>
<div class="section" id="references">
<h2><a class="toc-backref" href="#id27">References</a></h2>
<table class="docutils citation" frame="void" id="jls3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[JLS3]</a></td><td>Gosling, James, Joy, Bill, Steel, Guy and Bracha, Gilad.
<em>The Java Language Specification, Third Edition</em>.
Addison Wesley, 2005, ISBN 0-321-24678-0.
See also: <a class="reference external" href="http://java.sun.com/docs/books/jls/third_edition/html/j3TOC.html">http://java.sun.com/docs/books/jls/third_edition/html/j3TOC.html</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="jvms2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[JVMS2]</td><td><em>(<a class="fn-backref" href="#id4">1</a>, <a class="fn-backref" href="#id9">2</a>)</em> Lindholm, Tim and Yellin, Frank.
<em>The Java Virtual Machine Specification, Second Edition</em>.
Addison Wesley, 2003, ISBN 0201432943.
See also <a class="reference external" href="http://java.sun.com/docs/books/vmspec/2nd-edition/html/VMSpecTOC.doc.html">http://java.sun.com/docs/books/vmspec/2nd-edition/html/VMSpecTOC.doc.html</a>.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="pjvm" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[PJVM]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id6">2</a>, <a class="fn-backref" href="#id8">3</a>, <a class="fn-backref" href="#id10">4</a>)</em> Engel, Joshua.
<em>Programming For The Java Virtual Machine</em>.
Addison Wesley, 1999. ISBN 0-201-30972-6.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="jpl4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[JPL4]</a></td><td>Arnold, Ken, Gosling, James and Holmes, David.
<em>The Java Programming Language, Fourth Edition</em>.
Addison Wesley, 2009. ISBN 0-321-34980-6.</td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="jamex" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[JAMEX]</a></td><td>www.jamex.com. Neil Coffey.
<a class="reference external" href="http://www.javamex.com/tutorials/double_checked_locking.shtml">http://www.javamex.com/tutorials/double_checked_locking.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/synchronization_volatile.shtml">http://www.javamex.com/tutorials/synchronization_volatile.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/synchronization_concurrency_synchronized2.shtml">http://www.javamex.com/tutorials/synchronization_concurrency_synchronized2.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/synchronization_synchronized_method.shtml">http://www.javamex.com/tutorials/synchronization_synchronized_method.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/synchronization_concurrency_7_atomic_updaters.shtml">http://www.javamex.com/tutorials/synchronization_concurrency_7_atomic_updaters.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/collections/ConcurrentSkipListMap.shtml">http://www.javamex.com/tutorials/collections/ConcurrentSkipListMap.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/synchronization_volatile_typical_use.shtml">http://www.javamex.com/tutorials/synchronization_volatile_typical_use.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/double_checked_locking.shtml">http://www.javamex.com/tutorials/double_checked_locking.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/double_checked_locking_fixing.shtml">http://www.javamex.com/tutorials/double_checked_locking_fixing.shtml</a>
<a class="reference external" href="http://www.javamex.com/tutorials/synchronization_piggyback.shtml">http://www.javamex.com/tutorials/synchronization_piggyback.shtml</a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="toddg" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[TODDG]</a></td><td><a class="reference external" href="http://github.com/ToddG/experimental/java/concurrency">http://github.com/ToddG/experimental/java/concurrency</a></td></tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="footer">
<hr class="footer" />
Copyright (c) 2010 Todd D. Greenwood-Geer
</div>
</body>
</html>
